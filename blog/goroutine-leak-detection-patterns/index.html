<!DOCTYPE html><html lang="en" class="dark"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/icon.png"><meta name="generator" content="Astro v5.5.2"><!-- Font preloads --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://alexrios.me/blog/goroutine-leak-detection-patterns/"><!-- Primary Meta Tags --><title>Five ways to leak a goroutine | alexrios</title><meta name="title" content="Five ways to leak a goroutine"><meta name="description" content="Real-world goroutine leak patterns and how they are caught"><meta name="author" content="Alex Rios"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://alexrios.me/blog/goroutine-leak-detection-patterns/"><meta property="og:title" content="Five ways to leak a goroutine"><meta property="og:description" content="Real-world goroutine leak patterns and how they are caught"><meta property="og:image" content="https://alexrios.me/og-image/goroutine-leak-detection-patterns.png"><meta property="article:author" content="Alex Rios"><meta property="article:published_time" content="2025-12-29T03:00:00.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://alexrios.me/blog/goroutine-leak-detection-patterns/"><meta property="twitter:title" content="Five ways to leak a goroutine"><meta property="twitter:description" content="Real-world goroutine leak patterns and how they are caught"><meta property="twitter:image" content="https://alexrios.me/og-image/goroutine-leak-detection-patterns.png"><link rel="stylesheet" href="/_astro/about.BXhEje_b.css">
<link rel="stylesheet" href="/_astro/about.CGKMQgMR.css">
<style>li[data-astro-cid-zekvapgs]:before{content:"#";margin-right:-.5rem;color:var(--theme-accent)}.active-toc[data-astro-cid-zekvapgs]{color:var(--theme-accent)}button[data-astro-cid-xuhzuiaq]{position:fixed;bottom:1rem;left:82%;display:none;height:3rem;width:3rem;align-items:center;justify-content:center;border-radius:9999px;background-color:var(--theme-accent);color:var(--theme-bg);--tw-shadow: 0 1px 3px 0 rgb(0 0 0 / .1), 0 1px 2px -1px rgb(0 0 0 / .1);--tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}button[data-astro-cid-xuhzuiaq]:hover{--tw-scale-x: 1.25;--tw-scale-y: 1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-shadow: 0 20px 25px -5px rgb(0 0 0 / .1), 0 8px 10px -6px rgb(0 0 0 / .1);--tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}@media (min-width: 640px){button[data-astro-cid-xuhzuiaq]{bottom:2rem;height:2.5rem;width:2.5rem}}@media (min-width: 768px){button[data-astro-cid-xuhzuiaq]{left:90%}}@media (min-width: 1536px){button[data-astro-cid-xuhzuiaq]{left:75%}}
</style></head> <body> <header class="group relative mb-8 flex justify-between items-center gap-4" id="main-header" data-astro-cid-3ef6ksr2> <div class="block" data-astro-cid-3ef6ksr2> <a class="title whitespace-nowrap" href="/" aria-current="false" data-astro-cid-3ef6ksr2>alexrios</a> </div> <nav class="mt-4 bg-surface/95 sm:bg-bgColor absolute hidden top-8 w-full sm:block sm:static sm:mt-0 group-[.menu-open]:z-50 group-[.menu-open]:flex group-[.menu-open]:bg-bgColor" id="navigation-menu" aria-label="main menu" data-astro-cid-3ef6ksr2> <div class="space-y-1 px-2 pb-3 pt-2 sm:flex sm:px-0 sm:py-0 sm:space-y-0 sm:space-x-2" data-astro-cid-3ef6ksr2> <a href="/" class="block py-2 sm:py-0" title="Home" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a> <a href="/about" class="block py-2 sm:py-0" title="About" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> About </a> <a href="/blog" class="block py-2 sm:py-0" title="Blog" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a> <a href="/books" class="block py-2 sm:py-0" title="Books" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Books </a> <a href="/speaker" class="block py-2 sm:py-0" title="Speaker" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Speaker </a> <a href="/archive" class="block py-2 sm:py-0" title="Archive" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Archive </a>  <a href="/tags" class="sm:hidden block py-2 sm:py-0" title="tags" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Tags </a>  <a href="/series" class="sm:hidden block py-2 sm:py-0" title="series" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  </div> </nav> <div class="flex gap-2 items-center justify-center" data-astro-cid-3ef6ksr2> <button id="themeToggle" class="transition-all relative" aria-label="toggle theme" data-astro-cid-x3pjskd3> <svg width="25px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-astro-cid-x3pjskd3> <path class="sun opacity-100 transition-all dark:scale-0 dark:opacity-0" fill-rule="evenodd" d="M12 17.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zm0 1.5a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm12-7a.8.8 0 0 1-.8.8h-2.4a.8.8 0 0 1 0-1.6h2.4a.8.8 0 0 1 .8.8zM4 12a.8.8 0 0 1-.8.8H.8a.8.8 0 0 1 0-1.6h2.5a.8.8 0 0 1 .8.8zm16.5-8.5a.8.8 0 0 1 0 1l-1.8 1.8a.8.8 0 0 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM6.3 17.7a.8.8 0 0 1 0 1l-1.7 1.8a.8.8 0 1 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM12 0a.8.8 0 0 1 .8.8v2.5a.8.8 0 0 1-1.6 0V.8A.8.8 0 0 1 12 0zm0 20a.8.8 0 0 1 .8.8v2.4a.8.8 0 0 1-1.6 0v-2.4a.8.8 0 0 1 .8-.8zM3.5 3.5a.8.8 0 0 1 1 0l1.8 1.8a.8.8 0 1 1-1 1L3.5 4.6a.8.8 0 0 1 0-1zm14.2 14.2a.8.8 0 0 1 1 0l1.8 1.7a.8.8 0 0 1-1 1l-1.8-1.7a.8.8 0 0 1 0-1z" data-astro-cid-x3pjskd3></path> <path class="moon opacity-0 transition-all dark:scale-100 dark:opacity-100" fill-rule="evenodd" d="M16.5 6A10.5 10.5 0 0 1 4.7 16.4 8.5 8.5 0 1 0 16.4 4.7l.1 1.3zm-1.7-2a9 9 0 0 1 .2 2 9 9 0 0 1-11 8.8 9.4 9.4 0 0 1-.8-.3c-.4 0-.8.3-.7.7a10 10 0 0 0 .3.8 10 10 0 0 0 9.2 6 10 10 0 0 0 4-19.2 9.7 9.7 0 0 0-.9-.3c-.3-.1-.7.3-.6.7a9 9 0 0 1 .3.8z" data-astro-cid-x3pjskd3></path> </svg> </button>  <script>
  const theme = (() => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme');
    }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
      return 'light';
  })();

  if (theme === 'light') {
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }

  window.localStorage.setItem('theme', theme);

  const handleToggleClick = () => {
    const element = document.documentElement;
    element.classList.toggle("dark");

    const isDark = element.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }

  document.getElementById("themeToggle").addEventListener("click", handleToggleClick);
</script> <nav-button data-astro-cid-3ef6ksr2="true"> <div class="sm:hidden" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>open main menu</span> <button class="group flex items-center justify-center" type="button" id="navigation-menu-btn" aria-label="Open main menu" aria-expanded="false" aria-haspopup="menu" data-astro-cid-3ef6ksr2> <!-- icon when menu is closed --> <svg class="transform transition-all duration-150 ease-out group-aria-expanded:scale-0 group-aria-expanded:opacity-0 h-6 w-6 block group-aria-expanded:hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" data-astro-cid-3ef6ksr2></path> </svg> <!-- icon when menu is open --> <svg class="transform transition-all duration-150 ease-out h-6 w-6 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100 hidden group-aria-expanded:block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-astro-cid-3ef6ksr2></path> </svg> </button> </div> </nav-button> </div> </header>  <script type="module">class e extends HTMLElement{headerEl;mobileButtonEl;menuOpen;constructor(){super(),this.headerEl=document.getElementById("main-header"),this.mobileButtonEl=this.querySelector("button"),this.menuOpen=!1,this.mobileButtonEl.addEventListener("click",this.toggleMobileMenu)}toggleMobileMenu=()=>{this.headerEl.classList.toggle("menu-open"),this.menuOpen=!this.menuOpen,this.mobileButtonEl.setAttribute("aria-expanded",this.menuOpen.toString())}}customElements.define("nav-button",e);</script> <main class="grid grid-cols-1 gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-4">  <article class="cody-bg prose dark:prose-invert prose-cody text-textColor max-w-4xl"> <header class="space-y-2"> <div class="aspect-h-9 aspect-w-16 mb-6 w-full flex justify-center"> <img src="/leaking-sink.png" alt="leak patterns" class="m-0"> </div> <div class="md:sr-only not-sr-only"> <span>Part of series:</span> <a class="cody-link" href="/series/Goroutine Leak Detection">Goroutine Leak Detection</a> </div> <div class="flex gap-2 items-center"> <h1 class="text-3xl my-0">Five ways to leak a goroutine</h1>  </div> <span class="font-semibold text-textColor flex gap-2 items-center"> <time datetime="2025-12-29T03:00:00.000Z" title="29 December 2025"> 29 December 2025 </time> <span>
/ 13 min read </span>  </span> <ul class="not-prose flex gap-2 flex-wrap"> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" class="w-5 h-5" astro-icon="carbon:tag-group"><circle cx="10" cy="14" r="2" fill="currentColor"/><path fill="currentColor" d="M16 30a1 1 0 0 1-.71-.29L4.59 19A2 2 0 0 1 4 17.59V10a2 2 0 0 1 2-2h7.59a2 2 0 0 1 1.41.59l10.71 10.7a1 1 0 0 1 0 1.42l-9 9A1 1 0 0 1 16 30zM6 10v7.59l10 10L23.59 20l-10-10z"/><path fill="currentColor" d="M27.71 13.29 17 2.59A2 2 0 0 0 15.59 2H8a2 2 0 0 0-2 2v2h2V4h7.59l10 10-1.3 1.29 1.42 1.42 2-2a1 1 0 0 0 0-1.42z"/></svg> <li class="tag"> <a href="/tags/go">go</a> </li><li class="tag"> <a href="/tags/concurrency">concurrency</a> </li><li class="tag"> <a href="/tags/bugs">bugs</a> </li><li class="tag"> <a href="/tags/patterns">patterns</a> </li> </ul> </header> <hr class="my-4"> <main class="prose-headings:font-semibold prose-headings:ml-4 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none prose-a:text-accent">  <p>In the <a href="/blog/goroutine-leak-detection-gc-trick">previous post</a>, we walked through the technical mechanism behind Go’s goroutine leak detector: How it uses the garbage collector to identify channels and mutexes that have become unreachable, and how it marks goroutines waiting on those primitives as leaked.</p>
<p>Now it’s time to look at what that mechanism catches in practice.</p>
<blockquote>
<p>These aren’t academic examples cooked up to demonstrate a point. Every pattern we’re about to look at is pulled from the test suite, and every one of them represents a real bug that made it into production code.</p>
</blockquote>
<p>The <a href="https://github.com/golang/go/tree/master/src/runtime/testdata/testgoroutineleakprofile">GoKer test suite</a> includes 66 bugs extracted from major projects: <a href="https://github.com/cockroachdb/cockroach">CockroachDB</a> (18 bugs), <a href="https://github.com/kubernetes/kubernetes">Kubernetes</a> (14), <a href="https://github.com/moby/moby">Moby</a> (11), <a href="https://github.com/etcd-io/etcd">etcd</a> (7), <a href="https://github.com/grpc/grpc-go">gRPC</a> (6), and more from <a href="https://github.com/istio/istio">Istio</a>, <a href="https://github.com/gohugoio/hugo">Hugo</a>, <a href="https://github.com/syncthing/syncthing">Syncthing</a>, and <a href="https://github.com/knative">Knative</a>.
These are bugs that passed code review, passed testing, shipped to users, and caused actual incidents.</p>
<p>Let’s look at five patterns that show up again and again.</p>
<h2 id="pattern-1-the-early-return-when-error-handling-orphans-a-sender">Pattern 1: The early return (when error handling orphans a sender)</h2>
<p>This is the pattern from the <a href="/blog/goroutine-leak-detection-intro">second post</a>, but let’s see it in a slightly different form:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> earlyReturn</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">err</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // This goroutine will try to send</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doExpensiveWork</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">!=</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // Oops, we're leaving</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        return</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Only receive if there's no error</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p><strong>What happens</strong>: The sender goroutine doesn’t care about <code>err</code>. It’s going to do its work and try to send the result no matter what. But if <code>err</code> is non-nil, the main goroutine returns early, and that sender blocks forever on the send.</p>
<p><strong>Why the goroutine is leaked</strong>: When the code <code>early return</code>, the local variable <code>ch</code> goes out of scope. The channel becomes unreachable. Only the sender goroutine still has a reference to it (internally, in its <code>sudog</code>). Since the channel is unreachable, nobody can receive from it. The sender blocks forever on a send that will never complete.</p>
<p><strong>How the detector catches it</strong>: After the early return, the GC runs (triggered by the leak detection). The channel isn’t marked because there’s no path to it from running code. The leak detector sees: goroutine blocked on send, channel unreachable → leaked.</p>
<p><strong>Why it’s common</strong>: Error paths are where bugs hide. You test the happy path religiously. But that error case where the database is down, or the API returns an unexpected response, or the file doesn’t exist? That path might only run in production, and when it does, it leaves a goroutine behind.</p>
<p><strong>The fix</strong>: Either use a buffered channel so the send doesn’t block:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 1</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Buffer size 1</span></span></code></pre>
<p>Or use context-based cancellation to signal the goroutine:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> cancel </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">WithCancel</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Background</span><span style="color:#9399B2;--shiki-dark:#7C7F93">())</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">defer</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> cancel</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doExpensiveWork</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    select</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">:</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Done</span><span style="color:#9399B2;--shiki-dark:#7C7F93">():</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        return</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Cancelled, exit cleanly</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}()</span></span></code></pre>
<blockquote>
<p>I’ve seen this pattern in payment processing code, HTTP client libraries, and database drivers. Any time you have (spawn goroutine, potentially return early, receive from channel) you’re at risk.</p>
</blockquote>
<h2 id="pattern-2-the-unbuffered-channel-worker-parallel-processing-meets-early-exit">Pattern 2: The unbuffered channel worker (parallel processing meets early exit)</h2>
<p>This is the canonical example, adapted from the Go 1.26 release notes:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">type</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> result</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> struct</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    res </span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">workResult</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    err </span><span style="color:#CBA6F7;--shiki-dark:#8839EF">error</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> processWorkItems</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">ws</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">workItem</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> ([]</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">workResult</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Spawn a worker for each item</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> _</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> w </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> range</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ws </span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">w</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> workItem</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">            res</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> processWorkItem</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">w</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">            ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">res</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err</span><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">        }(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">w</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Collect results until we hit an error</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> results </span><span style="color:#9399B2;--shiki-dark:#7C7F93">[]</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">workResult</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 0</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> len</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ws</span><span style="color:#9399B2;--shiki-dark:#7C7F93">);</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i</span><span style="color:#94E2D5;--shiki-dark:#179299">++</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        r </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> r</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">err </span><span style="color:#94E2D5;--shiki-dark:#179299">!=</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">            return</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> r</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">err  </span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Remaining workers leak!</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">        }</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        results </span><span style="color:#94E2D5;--shiki-dark:#179299">=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> append</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">results</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> r</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">res</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    return</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> results</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p>Let’s trace through a concrete execution. Say <code>ws</code> has 10 items:</p>
<ol>
<li>We spawn 10 goroutines.</li>
<li>The first 3 finish quickly and send their results successfully.</li>
<li>The 4th worker encounters an error and sends that back.</li>
<li>The main goroutine receives the error and returns immediately.</li>
</ol>
<p>What about workers 5-10? Maybe worker 5 is almost done. Worker 6 just started. Workers 7-10 are in various states of progress. But they’ll all eventually try to send their results to <code>ch</code>, and when they do, they’ll block.</p>
<p>Why? Because <code>ch</code> is unbuffered, which means a send only succeeds if there’s a receiver ready to receive. But the receiver (the main goroutine) already left. The channel becomes unreachable (the function returned, the local variable is gone), and those workers are stuck forever.</p>
<p>The traditional tools miss this because when you grab a regular goroutine profile, you see:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="lua"><code><span class="line"><span style="color:#FAB387;--shiki-dark:#FE640B">6</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> goroutines blocked on channel send at processWorkItem</span><span style="color:#94E2D5;--shiki-dark:#179299">+</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x123</span></span></code></pre>
<p>That looks… fine? Goroutines waiting to send results is completely normal in this pattern. You can’t tell which ones are legitimately waiting for their results to be received vs. which ones are waiting on a channel that nobody will ever receive from.</p>
<p>But the leak profile shows:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="lua"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">5</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">6</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">7</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">8</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">9</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">10</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]</span></span></code></pre>
<p>That <code>(leaked)</code> annotation is <strong>gold</strong>. Now you know: these aren’t just waiting, they’re <em>stuck</em>.</p>
<p>I’m not here to just complain, I’m here to solve it.</p>
<p>Either make the channel buffered so sends don’t block:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> len</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ws</span><span style="color:#9399B2;--shiki-dark:#7C7F93">))</span></span></code></pre>
<p>Or use a context to signal cancellation:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> cancel </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">WithCancel</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Background</span><span style="color:#9399B2;--shiki-dark:#7C7F93">())</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">defer</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> cancel</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">item</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> workItem</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    select</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">res</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err</span><span style="color:#9399B2;--shiki-dark:#7C7F93">}:</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Done</span><span style="color:#9399B2;--shiki-dark:#7C7F93">():</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        return</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Cancelled, don't send</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">w</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span></code></pre>
<p>Or drain the channel on early return:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">defer</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 0</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> len</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ws</span><span style="color:#9399B2;--shiki-dark:#7C7F93">);</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i</span><span style="color:#94E2D5;--shiki-dark:#179299">++</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">        &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch  </span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Receive from everyone</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}()</span></span></code></pre>
<p>Each approach has trade-offs (shocking), but they all prevent the leak.</p>
<h2 id="pattern-3-the-no-close-range-worker-pools-that-never-end">Pattern 3: The no-close range (worker pools that never end)</h2>
<p>Here’s one that bit a lot of long-running services:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> noCloseRange</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">list</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic"> workers</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> int</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Start worker pool</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 0</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> workers</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i</span><span style="color:#94E2D5;--shiki-dark:#179299">++</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">            for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> range</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ch </span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">                process</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">item</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">            }</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">            // Never reaches here</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">        }()</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Send all items</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> _</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> range</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> list </span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Function returns here... but workers keep waiting</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p><strong>What happens</strong>: The workers are blocked in <code>for item := range ch</code>. They’re waiting for either:</p>
<ol>
<li>The next item to be sent to <code>ch</code>, or</li>
<li>The channel to be closed (which would break the loop)</li>
</ol>
<p>When <code>noCloseRange</code> returns, neither happens. The channel becomes unreachable, but it’s never closed. Those workers sit in their range loops forever, waiting for items that will never come.</p>
<p><strong>Why it’s common</strong>: The worker pool pattern is everywhere. You spin up some goroutines, feed them work through a channel, and… you’re supposed to close the channel when you’re done. But it’s easy to forget, especially in error paths or when refactoring.</p>
<p><strong>How the detector catches it</strong>: After the function returns, <code>ch</code> is unreachable. The workers are blocked in range, which internally is a receive operation. GC doesn’t mark the channel. Leak detector sees goroutines waiting on an unreachable channel → leaked.</p>
<p>An easy fix is closing the channel when you’re done sending:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">defer</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> close</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span></code></pre>
<p>Or if you’re worried about double-close panics for adding this line in the wrong place:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> noCloseRange</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">list</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic"> workers</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> int</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 0</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> workers</span><span style="color:#9399B2;--shiki-dark:#7C7F93">;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> i</span><span style="color:#94E2D5;--shiki-dark:#179299">++</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">            for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> range</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ch </span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">                process</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">item</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">            }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">        }()</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        defer</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> close</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        for</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> _</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> range</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> list </span><span style="color:#9399B2;--shiki-dark:#7C7F93">{</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">            ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> item</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">        }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }()</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p><strong>TLDR:</strong> <code>for item := range ch</code> will only exit when the channel is closed. If you never close it, the loop never exits.</p>
<blockquote>
<p>This pattern shows up in microservices with request-processing pools, background job processors, and stream processing pipelines. Any time you have: create channel, spawn workers that range over it, return. You need to close that channel.</p>
</blockquote>
<h2 id="pattern-4-the-context-timeout-when-cancellation-wins-the-race">Pattern 4: The context timeout (when cancellation wins the race)</h2>
<p>This one’s my favorite because it’s intermittent:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> timeout</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">ctx</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">Context</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doSlowWork</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result  </span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// This might never complete</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    select</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span><span style="color:#9399B2;--shiki-dark:#7C7F93">:</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">        use</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Done</span><span style="color:#9399B2;--shiki-dark:#7C7F93">():</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // Timeout! But what about the sender?</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        return</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p><strong>What happens</strong>: There’s a race between the worker finishing and the context timing out. Sometimes the worker wins: it sends its result, we receive it, everyone’s happy. Sometimes the timeout wins: we receive from <code>ctx.Done()</code>, return early, and the sender gets stuck.</p>
<p><strong>Why it’s tricky</strong>: This doesn’t always leak. It only leaks when the timeout fires before the worker finishes. In testing, the worker might always finish quickly. In production, under load, with slow databases or network hiccups, the timeout starts firing more often. Leaks accumulate.</p>
<p><strong>How the detector catches it</strong>: When <code>timeout</code> returns via the <code>ctx.Done()</code> case, <code>ch</code> falls out of scope. If the sender tries to send after that, it blocks on an unreachable channel. The leak detector identifies it.</p>
<p>Luckily enough, the fix is simple: Make the channel buffered so the send doesn’t block:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Use buffered channel to prevent blocking</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Buffer size of 1 allows the goroutine to complete even if timeout fires</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 1</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span></code></pre>
<p>Now even if the timeout fires, the sender can complete its send and exit cleanly. The result gets dropped (nobody’s receiving), <strong>but the goroutine doesn’t leak</strong>.</p>
<p><strong>Note</strong>: This works for single-sender scenarios. If you have multiple senders, use context-based cancellation instead (see the fix in Pattern 1).</p>
<p>Or, if you’re feeling adventurous, make the sender context-aware:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">go</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doSlowWork</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    select</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> result</span><span style="color:#9399B2;--shiki-dark:#7C7F93">:</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    case</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ctx</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Done</span><span style="color:#9399B2;--shiki-dark:#7C7F93">():</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">        return</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}()</span></span></code></pre>
<p>This pattern shows up in HTTP clients (request timeout), gRPC calls (deadline exceeded), database queries (query timeout), and basically anywhere you use <code>context.WithTimeout</code> or <code>context.WithDeadline</code> around concurrent work.</p>
<p>The Go team’s test suite includes multiple instances of this from production systems. It’s not a hypothetical. People actually ship this bug.</p>
<h2 id="pattern-5-the-double-send-the-missing-return-statement">Pattern 5: The double send (the missing return statement)</h2>
<p>This one makes me wince every time I see it:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doubleSend</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">ch</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic"> err</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">!=</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Send error result</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // Missing: return</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // OOPS: Still executing here</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> struct</span><span style="color:#9399B2;--shiki-dark:#7C7F93">{}{}</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Send success result (BLOCKS FOREVER if receiver already read)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Caller side - receives once, then returns</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> caller</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> make</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic"> any</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    go</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> doubleSend</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> someErr</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    result </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#94E2D5;--shiki-dark:#179299"> &#x3C;-</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch  </span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">// Receives the first send</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Returns here, channel becomes unreachable</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // If doubleSend tries second send, it leaks</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p><strong>What happens</strong>: If <code>err</code> is non-nil, we send <code>nil</code> to indicate failure. But we forgot the <code>return</code> statement. Execution continues to the next line, where we try to send again. If <code>ch</code> is unbuffered and the receiver only reads once, that second send blocks forever.</p>
<p><strong>Why it happens</strong>: Refactoring. Code review fatigue. That moment at 11pm when you’re “just fixing one more thing”. You turn an <code>else</code> block into an <code>if</code> block and forget that the <code>else</code> was implicitly returning.</p>
<p><strong>The impact</strong>: One missing line. One missing <code>return</code>. Infinite goroutine leak.</p>
<p><strong>How the detector catches it</strong>: After the function is called and the receiver reads once, the channel becomes unreachable (assuming it was local to the caller). The goroutine is stuck in the second send. The leak detector marks it.</p>
<p>I think you already guessed it, but let’s make this fix clear. Add the <code>return</code>:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">!=</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    return</span><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">  // Don't forget this!</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> struct</span><span style="color:#9399B2;--shiki-dark:#7C7F93">{}{}</span></span></code></pre>
<p>Or use an <code>else</code> block so you can’t possibly fall through:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">!=</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> else</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    ch </span><span style="color:#94E2D5;--shiki-dark:#179299">&#x3C;-</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> struct</span><span style="color:#9399B2;--shiki-dark:#7C7F93">{}{}</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<blockquote>
<p>I’ve seen this cause a production incident at a payment processor. The leaked goroutines accumulated over a week until the service started failing health checks from memory pressure. Total cost: several hours of incident response, service restarts, and a very sheepish PR with a one-line fix.</p>
</blockquote>
<h2 id="the-production-impact-these-arent-academic-exercises">The production impact (these aren’t academic exercises)</h2>
<p>Let’s be clear about what we’re looking at here. The <a href="https://github.com/golang/go/tree/master/src/runtime/testdata/testgoroutineleakprofile">GoKer test suite</a> includes 66 real bugs:</p>
<ul>
<li><strong>CockroachDB</strong>: 18 instances</li>
<li><strong>Kubernetes</strong>: 14 instances</li>
<li><strong>Moby</strong>: 11 instances</li>
<li><strong>etcd</strong>: 7 instances</li>
<li><strong>gRPC</strong>: 6 instances</li>
<li><strong>Istio</strong>: 3 instances</li>
<li><strong>Hugo</strong>: 2 instances</li>
<li><strong>Syncthing</strong>: 2 instances</li>
<li><strong>Knative Serving</strong>: 1 instance</li>
</ul>
<p>These aren’t bugs that were caught in code review. They made it past testing. They shipped to users. They ran in production and caused real problems. Memory leaks, service degradation, outages.</p>
<p>The fact that projects of this caliber (with experienced teams, rigorous review processes, and extensive test suites) all shipped goroutine leaks tells you something: <strong>this is <em>hard</em></strong>. Concurrent code is subtle. Error paths are undertested. And until now, we haven’t had good tooling to catch these bugs.</p>
<h2 id="detecting-your-own-leaks">Detecting your own leaks</h2>
<p>So how do you use this to find leaks in your code? It’s straightforward. Build with the experiment enabled:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">GOEXPERIMENT</span><span style="color:#94E2D5;--shiki-dark:#179299">=</span><span style="color:#A6E3A1;--shiki-dark:#40A02B">goroutineleakprofile</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> go</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> test</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> ./...</span></span></code></pre>
<p>Then in your tests, you can use something similar to the following snippet:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> TestNoLeaks</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">t</span><span style="color:#94E2D5;--shiki-dark:#179299"> *</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">testing</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">T</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    prof </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> pprof</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Lookup</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#A6E3A1;--shiki-dark:#40A02B">"goroutineleak"</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">	if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> prof </span><span style="color:#94E2D5;--shiki-dark:#179299">==</span><span style="color:#F38BA8;--shiki-dark:#D20F39"> nil</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        t</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Skip</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#A6E3A1;--shiki-dark:#40A02B">"goroutineleak profile not available (build with GOEXPERIMENT=goroutineleakprofile)"</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Run your code</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">    runMyComplexConcurrentThing</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Check for leaks</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> buf </span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">bytes</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">Buffer</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    prof</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">WriteTo</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#94E2D5;--shiki-dark:#179299">&#x26;</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">buf</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#FAB387;--shiki-dark:#FE640B"> 2</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    if</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> strings</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Contains</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">buf</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">String</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(),</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> "(leaked)"</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        t</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#A6E3A1;--shiki-dark:#40A02B">"Goroutine leak detected!"</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        t</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Log</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">buf</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">String</span><span style="color:#9399B2;--shiki-dark:#7C7F93">())</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    }</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p>Or in production, hit the HTTP endpoint:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">curl</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> http://localhost:6060/debug/pprof/goroutineleak</span></span></code></pre>
<p>The output looks like:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="lua"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutineleak </span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">profile</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">: total </span><span style="color:#FAB387;--shiki-dark:#FE640B">3</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">42</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]:</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">main.processWorkItems.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">func1</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">()</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">25</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x45</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">created by main.processWorkItems</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">20</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x123</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">43</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [chan </span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">send</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]:</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">main.processWorkItems.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">func1</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">()</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">25</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x45</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">created by main.processWorkItems</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">20</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x123</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">44</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> [sync.Mutex.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Lock</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> (leaked)]:</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">main.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">doubleLock</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">()</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">mutex.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">15</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x78</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">created by main.startWorker</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">    /</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">mutex.</span><span style="color:#F9E2AF;font-style:italic;--shiki-dark:#DF8E1D;--shiki-dark-font-style:italic">go</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">10</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#FAB387;--shiki-dark:#FE640B">0x56</span></span></code></pre>
<p>Look for:</p>
<ul>
<li>The <code>(leaked)</code> annotation in the status line</li>
<li>The wait reason (chan send, sync.Mutex.Lock, etc.)</li>
<li>The creation site (where the goroutine was spawned)</li>
</ul>
<p>That’s your debugging starting point. You know which goroutines are leaked, what they’re waiting on, and where they came from.</p>
<h2 id="whats-next">What’s next</h2>
<p>We’ve seen the problem, we’ve seen the solution, and we’ve seen what it catches. But there’s one more piece to this story: how did we get here?</p>
<p>In the next and final post, we’ll talk about the seven-year journey from proposal to implementation. We’ll look at Vlad Saioc’s research at Uber that made this possible, the academic paper that validated the approach, and the GоKer tool that provided the test dataset. We’ll also cover how to actually use this feature in your projects, best practices for integration testing and production monitoring, and what the future might hold.</p>
<p>That’s why this is more than just a runtime feature. It’s the result of years of research into real-world concurrency bugs, extensive collaboration between academia and industry, and careful engineering to make it production-ready.</p>
<hr>
<p><strong>Previous</strong>: <a href="/blog/goroutine-leak-detection-gc-trick">← The GC trick that catches leaks</a></p>
<hr>
<h3 id="outro">OUTRO</h3>
<p><strong>A note about profiling</strong>: The second argument to <code>WriteTo</code> is the debug level, which controls the output format:</p>
<ul>
<li><code>0</code>: gzip-compressed protobuf (for go tool pprof).</li>
<li><code>1</code>: Human-readable text, compact.</li>
<li><code>2</code>: Human-readable text with full stack traces.</li>
</ul>
<p>Using 2 produces output like:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">goroutine </span><span style="color:#FAB387;--shiki-dark:#FE640B">42</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> [</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">chan</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> send </span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">leaked</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)]:</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">main</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">processWorkItems</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">func1</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">go</span><span style="color:#9399B2;--shiki-dark:#7C7F93">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">25</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">0x</span><span style="color:#FAB387;--shiki-dark:#FE640B">45</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">created by main</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">processWorkItems</span></span>
<span class="line"><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">app</span><span style="color:#94E2D5;--shiki-dark:#179299">/</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">worker</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">go</span><span style="color:#9399B2;--shiki-dark:#7C7F93">:</span><span style="color:#FAB387;--shiki-dark:#FE640B">20</span><span style="color:#94E2D5;--shiki-dark:#179299"> +</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">0x</span><span style="color:#FAB387;--shiki-dark:#FE640B">123</span></span></code></pre>
<p>This format is what you need to:</p>
<ol>
<li>Search for “(leaked)” in the string.</li>
<li>See the full stack trace when a leak is found.</li>
</ol>
<p>Using <code>0</code> would give binary data (useless for string searching). Using <code>1</code> would work but gives less detail in the stack traces.</p>  </main> <button id="back-to-top-btn" aria-label="back to top" class="z-50" data-astro-cid-xuhzuiaq> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" data-astro-cid-xuhzuiaq="true" class="w-7 h-7 sm:w-5 s:h-6" astro-icon="carbon:arrow-up"><path fill="currentColor" d="M16 4 6 14l1.41 1.41L15 7.83V28h2V7.83l7.59 7.58L26 14 16 4z"/></svg> </button>  <script type="module">const e=document.getElementById("back-to-top-btn");e&&(e.addEventListener("click",()=>{document.body.scrollTop=0,document.documentElement.scrollTop=0}),window.addEventListener("scroll",()=>{window.scrollY<document.documentElement.clientHeight?(e.classList.remove("fade-in"),e.classList.add("fade-out"),e.style.display="flex"):(e.classList.remove("fade-out"),e.classList.add("fade-in"))}));</script> </article>   <aside class="hidden sm:block"> <div class="flex flex-col space-y-2"> <h2 class="font-semibold text-lg text-textColor">Alex Rios</h2> <p>alexrios.me</p> <div class="flex flex-wrap items-end gap-x-4"> <ul class="flex flex-wrap flex-1 items-center gap-x-2 sm:flex-initial"> <li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://github.com/alexrios" target="_blank" rel="noopener noreferrer" title="Github"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:github"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> <span class="sr-only">Github</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://linkedin.com/in/the-alex-rios" target="_blank" rel="noopener noreferrer" title="LinkedIn"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:linkedin"><path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg> <span class="sr-only">LinkedIn</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://x.com/alextrending" target="_blank" rel="noopener noreferrer" title="twitter"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:twitter"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg> <span class="sr-only">twitter</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="/rss.xml" target="_blank" rel="noopener noreferrer" title="rss"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:rss"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg> <span class="sr-only">rss</span> </a> </li> </ul> </div> <span class="!my-4 text-accent" aria-hidden>---</span>
                    <p> Real-world goroutine leak patterns and how they are caught </p> <div class="pt-2 hidden md:block"> <span>Part of series: </span> <br> <ul> <li><a class="cody-link" href="/series/Goroutine Leak Detection">Goroutine Leak Detection</a></li> </ul> </div>  </div> <nav class="sticky top-20 order-2 hidden basis-64 lg:block"> <hr> <h2 class="font-bold text-lg">Table of Contents</h2> <ul class="-me-32" id="toc"> <li data-astro-cid-zekvapgs> <a href="#pattern-1-the-early-return-when-error-handling-orphans-a-sender" id="toc-pattern-1-the-early-return-when-error-handling-orphans-a-sender" data-astro-cid-zekvapgs> Pattern 1: The early return (when error handling orphans a sender) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#pattern-2-the-unbuffered-channel-worker-parallel-processing-meets-early-exit" id="toc-pattern-2-the-unbuffered-channel-worker-parallel-processing-meets-early-exit" data-astro-cid-zekvapgs> Pattern 2: The unbuffered channel worker (parallel processing meets early exit) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#pattern-3-the-no-close-range-worker-pools-that-never-end" id="toc-pattern-3-the-no-close-range-worker-pools-that-never-end" data-astro-cid-zekvapgs> Pattern 3: The no-close range (worker pools that never end) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#pattern-4-the-context-timeout-when-cancellation-wins-the-race" id="toc-pattern-4-the-context-timeout-when-cancellation-wins-the-race" data-astro-cid-zekvapgs> Pattern 4: The context timeout (when cancellation wins the race) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#pattern-5-the-double-send-the-missing-return-statement" id="toc-pattern-5-the-double-send-the-missing-return-statement" data-astro-cid-zekvapgs> Pattern 5: The double send (the missing return statement) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#the-production-impact-these-arent-academic-exercises" id="toc-the-production-impact-these-arent-academic-exercises" data-astro-cid-zekvapgs> The production impact (these aren’t academic exercises) </a>  </li> <li data-astro-cid-zekvapgs> <a href="#detecting-your-own-leaks" id="toc-detecting-your-own-leaks" data-astro-cid-zekvapgs> Detecting your own leaks </a>  </li> <li data-astro-cid-zekvapgs> <a href="#whats-next" id="toc-whats-next" data-astro-cid-zekvapgs> What’s next </a> <ul class="ml-2" data-astro-cid-zekvapgs> <li data-astro-cid-zekvapgs> <a href="#outro" id="toc-outro" data-astro-cid-zekvapgs> OUTRO </a>  </li>  </ul> </li>  </ul> </nav> <script type="module">const c=document.getElementById("toc");c&&c?.addEventListener("click",t=>{const n=window.location.hash.slice(1),e=document.getElementById(`toc-${n}`);e instanceof HTMLElement&&e?.classList.remove("active-toc"),t.target instanceof HTMLElement&&t.target.classList.add("active-toc")});</script> </aside> </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold sm:flex-row sm:justify-between sm:text-xs text-textColor mb-8"> <div class="mr-2 sm:mr-0">
Copyright &copy; 2025  Alex Rios </div> <nav aria-label="More on this site" class="gap-x-0 sm:gap-x-2 sm:flex sm:divide-x sm:divide-accent"> <a href="/" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Home </a><a href="/about" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> About </a><a href="/blog" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Blog </a><a href="/books" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Books </a><a href="/speaker" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Speaker </a><a href="/archive" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Archive </a> </nav> </footer> </body></html> <script type="module">const n='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19V1h9l6 6v12zm8-11h5l-5-5zM2 23V7h2v14h11v2z"/></svg>',i=Array.from(document.querySelectorAll("pre.astro-code"));for(const t of i){let o=t.parentElement;if(o){let c=document.createElement("div");o.replaceChild(c,t),c.classList.add("relative"),c.appendChild(t);const e=document.createElement("button");e.className="cody-copy-code",e.innerHTML=n,e.title="Copy code block",t.setAttribute("tabindex","0"),c.appendChild(e),e.addEventListener("click",async()=>{await r(t,e)})}}async function r(t,o){const e=t.querySelector("code")?.innerText??"";await navigator.clipboard.writeText(e),o.innerText="Code Copied",setTimeout(()=>{o.innerHTML=n},700)}</script>