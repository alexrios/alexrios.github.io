<!DOCTYPE html><html lang="en" class="dark"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/icon.png"><meta name="generator" content="Astro v5.5.2"><!-- Font preloads --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://alexrios.me/blog/secret-package/"><!-- Primary Meta Tags --><title>Erasing secrets in Go | alexrios</title><meta name="title" content="Erasing secrets in Go"><meta name="description" content="the runtime/secret Package"><meta name="author" content="Alex Rios"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://alexrios.me/blog/secret-package/"><meta property="og:title" content="Erasing secrets in Go"><meta property="og:description" content="the runtime/secret Package"><meta property="og:image" content="https://alexrios.me/og-image/secret-package.png"><meta property="article:author" content="Alex Rios"><meta property="article:published_time" content="2025-12-14T03:00:00.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://alexrios.me/blog/secret-package/"><meta property="twitter:title" content="Erasing secrets in Go"><meta property="twitter:description" content="the runtime/secret Package"><meta property="twitter:image" content="https://alexrios.me/og-image/secret-package.png"><link rel="stylesheet" href="/_astro/about.BXhEje_b.css">
<link rel="stylesheet" href="/_astro/about.CGKMQgMR.css">
<style>li[data-astro-cid-zekvapgs]:before{content:"#";margin-right:-.5rem;color:var(--theme-accent)}.active-toc[data-astro-cid-zekvapgs]{color:var(--theme-accent)}button[data-astro-cid-xuhzuiaq]{position:fixed;bottom:1rem;left:82%;display:none;height:3rem;width:3rem;align-items:center;justify-content:center;border-radius:9999px;background-color:var(--theme-accent);color:var(--theme-bg);--tw-shadow: 0 1px 3px 0 rgb(0 0 0 / .1), 0 1px 2px -1px rgb(0 0 0 / .1);--tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}button[data-astro-cid-xuhzuiaq]:hover{--tw-scale-x: 1.25;--tw-scale-y: 1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-shadow: 0 20px 25px -5px rgb(0 0 0 / .1), 0 8px 10px -6px rgb(0 0 0 / .1);--tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}@media (min-width: 640px){button[data-astro-cid-xuhzuiaq]{bottom:2rem;height:2.5rem;width:2.5rem}}@media (min-width: 768px){button[data-astro-cid-xuhzuiaq]{left:90%}}@media (min-width: 1536px){button[data-astro-cid-xuhzuiaq]{left:75%}}
</style></head> <body> <header class="group relative mb-8 flex justify-between items-center gap-4" id="main-header" data-astro-cid-3ef6ksr2> <div class="block" data-astro-cid-3ef6ksr2> <a class="title whitespace-nowrap" href="/" aria-current="false" data-astro-cid-3ef6ksr2>alexrios</a> </div> <nav class="mt-4 bg-surface/95 sm:bg-bgColor absolute hidden top-8 w-full sm:block sm:static sm:mt-0 group-[.menu-open]:z-50 group-[.menu-open]:flex group-[.menu-open]:bg-bgColor" id="navigation-menu" aria-label="main menu" data-astro-cid-3ef6ksr2> <div class="space-y-1 px-2 pb-3 pt-2 sm:flex sm:px-0 sm:py-0 sm:space-y-0 sm:space-x-2" data-astro-cid-3ef6ksr2> <a href="/" class="block py-2 sm:py-0" title="Home" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a> <a href="/about" class="block py-2 sm:py-0" title="About" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> About </a> <a href="/blog" class="block py-2 sm:py-0" title="Blog" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a> <a href="/books" class="block py-2 sm:py-0" title="Books" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Books </a> <a href="/speaker" class="block py-2 sm:py-0" title="Speaker" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Speaker </a> <a href="/archive" class="block py-2 sm:py-0" title="Archive" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Archive </a>  <a href="/tags" class="sm:hidden block py-2 sm:py-0" title="tags" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Tags </a>  <a href="/series" class="sm:hidden block py-2 sm:py-0" title="series" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  </div> </nav> <div class="flex gap-2 items-center justify-center" data-astro-cid-3ef6ksr2> <button id="themeToggle" class="transition-all relative" aria-label="toggle theme" data-astro-cid-x3pjskd3> <svg width="25px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-astro-cid-x3pjskd3> <path class="sun opacity-100 transition-all dark:scale-0 dark:opacity-0" fill-rule="evenodd" d="M12 17.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zm0 1.5a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm12-7a.8.8 0 0 1-.8.8h-2.4a.8.8 0 0 1 0-1.6h2.4a.8.8 0 0 1 .8.8zM4 12a.8.8 0 0 1-.8.8H.8a.8.8 0 0 1 0-1.6h2.5a.8.8 0 0 1 .8.8zm16.5-8.5a.8.8 0 0 1 0 1l-1.8 1.8a.8.8 0 0 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM6.3 17.7a.8.8 0 0 1 0 1l-1.7 1.8a.8.8 0 1 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM12 0a.8.8 0 0 1 .8.8v2.5a.8.8 0 0 1-1.6 0V.8A.8.8 0 0 1 12 0zm0 20a.8.8 0 0 1 .8.8v2.4a.8.8 0 0 1-1.6 0v-2.4a.8.8 0 0 1 .8-.8zM3.5 3.5a.8.8 0 0 1 1 0l1.8 1.8a.8.8 0 1 1-1 1L3.5 4.6a.8.8 0 0 1 0-1zm14.2 14.2a.8.8 0 0 1 1 0l1.8 1.7a.8.8 0 0 1-1 1l-1.8-1.7a.8.8 0 0 1 0-1z" data-astro-cid-x3pjskd3></path> <path class="moon opacity-0 transition-all dark:scale-100 dark:opacity-100" fill-rule="evenodd" d="M16.5 6A10.5 10.5 0 0 1 4.7 16.4 8.5 8.5 0 1 0 16.4 4.7l.1 1.3zm-1.7-2a9 9 0 0 1 .2 2 9 9 0 0 1-11 8.8 9.4 9.4 0 0 1-.8-.3c-.4 0-.8.3-.7.7a10 10 0 0 0 .3.8 10 10 0 0 0 9.2 6 10 10 0 0 0 4-19.2 9.7 9.7 0 0 0-.9-.3c-.3-.1-.7.3-.6.7a9 9 0 0 1 .3.8z" data-astro-cid-x3pjskd3></path> </svg> </button>  <script>
  const theme = (() => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme');
    }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
      return 'light';
  })();

  if (theme === 'light') {
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }

  window.localStorage.setItem('theme', theme);

  const handleToggleClick = () => {
    const element = document.documentElement;
    element.classList.toggle("dark");

    const isDark = element.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }

  document.getElementById("themeToggle").addEventListener("click", handleToggleClick);
</script> <nav-button data-astro-cid-3ef6ksr2="true"> <div class="sm:hidden" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>open main menu</span> <button class="group flex items-center justify-center" type="button" id="navigation-menu-btn" aria-label="Open main menu" aria-expanded="false" aria-haspopup="menu" data-astro-cid-3ef6ksr2> <!-- icon when menu is closed --> <svg class="transform transition-all duration-150 ease-out group-aria-expanded:scale-0 group-aria-expanded:opacity-0 h-6 w-6 block group-aria-expanded:hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" data-astro-cid-3ef6ksr2></path> </svg> <!-- icon when menu is open --> <svg class="transform transition-all duration-150 ease-out h-6 w-6 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100 hidden group-aria-expanded:block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-astro-cid-3ef6ksr2></path> </svg> </button> </div> </nav-button> </div> </header>  <script type="module">class e extends HTMLElement{headerEl;mobileButtonEl;menuOpen;constructor(){super(),this.headerEl=document.getElementById("main-header"),this.mobileButtonEl=this.querySelector("button"),this.menuOpen=!1,this.mobileButtonEl.addEventListener("click",this.toggleMobileMenu)}toggleMobileMenu=()=>{this.headerEl.classList.toggle("menu-open"),this.menuOpen=!this.menuOpen,this.mobileButtonEl.setAttribute("aria-expanded",this.menuOpen.toString())}}customElements.define("nav-button",e);</script> <main class="grid grid-cols-1 gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-4">  <article class="cody-bg prose dark:prose-invert prose-cody text-textColor max-w-4xl"> <header class="space-y-2"> <div class="aspect-h-9 aspect-w-16 mb-6 w-full flex justify-center"> <img src="/cpu.png" alt="secret" class="m-0"> </div> <div class="md:sr-only not-sr-only"> <span>Part of series:</span> <a class="cody-link" href="/series/Go 1.26">Go 1.26</a> </div> <div class="flex gap-2 items-center"> <h1 class="text-3xl my-0">Erasing secrets in Go</h1>  </div> <span class="font-semibold text-textColor flex gap-2 items-center"> <time datetime="2025-12-14T03:00:00.000Z" title="14 December 2025"> 14 December 2025 </time> <span>
/ 10 min read </span>  </span> <ul class="not-prose flex gap-2 flex-wrap"> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" class="w-5 h-5" astro-icon="carbon:tag-group"><circle cx="10" cy="14" r="2" fill="currentColor"/><path fill="currentColor" d="M16 30a1 1 0 0 1-.71-.29L4.59 19A2 2 0 0 1 4 17.59V10a2 2 0 0 1 2-2h7.59a2 2 0 0 1 1.41.59l10.71 10.7a1 1 0 0 1 0 1.42l-9 9A1 1 0 0 1 16 30zM6 10v7.59l10 10L23.59 20l-10-10z"/><path fill="currentColor" d="M27.71 13.29 17 2.59A2 2 0 0 0 15.59 2H8a2 2 0 0 0-2 2v2h2V4h7.59l10 10-1.3 1.29 1.42 1.42 2-2a1 1 0 0 0 0-1.42z"/></svg> <li class="tag"> <a href="/tags/go">go</a> </li><li class="tag"> <a href="/tags/package">package</a> </li><li class="tag"> <a href="/tags/secret">secret</a> </li> </ul> </header> <hr class="my-4"> <main class="prose-headings:font-semibold prose-headings:ml-4 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none prose-a:text-accent">  <p>When you work with cryptographic keys, passwords, or other sensitive data in your programs, you‚Äôve got a problem that‚Äôs been lurking in the shadows for decades: even after you‚Äôre done using that data, it‚Äôs still sitting there in memory. Stack frames, registers, heap allocations‚Äîthey all become a kind of archaeological record of your secrets, waiting for someone with a memory dump or a debugger to come along and dig them up.</p>
<p>Go will introduce an experimental <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret.go"><code>runtime/secret</code></a> package that attempts to solve this problem (in a way that‚Äôs actually practical). It‚Äôs the kind of feature that makes you wonder why it took this long, until you start thinking about the implementation details and realize, ‚Äúoh, <em>that‚Äôs</em> why.‚Äù</p>
<h2 id="the-problem-memory-is-a-tattoo-not-a-whiteboard">The problem: memory is a tattoo, not a whiteboard</h2>
<p>Let‚Äôs start with what we‚Äôre trying to solve here. When you write code that handles sensitive data, let‚Äôs say you‚Äôre implementing TLS or processing payment card numbers, the data flows through your program: it lives in registers when the CPU is actively working with it, on the stack as local variables, and on the heap when you allocate memory. Once you‚Äôre done with it, you might set those variables to zero or nil and call it a day.</p>
<p>But here‚Äôs the issue: that doesn‚Äôt actually erase the data. When you reassign a variable, you‚Äôre just telling the program to stop caring about that memory location. The actual bytes? They‚Äôre still there, hanging out, waiting for something else to overwrite them. And if someone gets access to your process memory‚Äîthrough a core dump, a memory vulnerability, or just straight-up root access‚Äîthey can go fishing for those old values.</p>
<p>This matters a lot for forward secrecy. If you‚Äôre doing a key exchange and someone later dumps your process memory, you don‚Äôt want them to be able to reconstruct old session keys. You want those keys <em>gone</em>. Not ‚Äútechnically deallocated‚Äù gone, but ‚Äúoverwritten with zeros and impossible to recover‚Äù, ‚Äúgone gone‚Äù.</p>
<p>The security folks have been worried about this for ages, and for good reason. You can write the most bulletproof crypto code in the world, but if your secrets are just sitting there in memory like old newspapers in the attic, you‚Äôve got a problem.</p>
<h2 id="the-answer-secretdo">The answer <code>secret.Do</code></h2>
<p>The new <code>runtime/secret</code> package gives you a function called <code>Do</code> that wraps your sensitive operations. Here‚Äôs the basic idea:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">import</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> "runtime/secret"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">secret</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Do</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Handle your sensitive data here</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    key </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> deriveEncryptionKey</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#94E2D5;--shiki-dark:#179299">...</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    plaintext </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decrypt</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ciphertext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> key</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">    process</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // When this function returns, Go will erase everything</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">})</span></span></code></pre>
<p>When <code>secret.Do</code> returns, the Go runtime actively erases:</p>
<ul>
<li><strong>All registers</strong> that were used by your function.</li>
<li><strong>The entire stack</strong> that your function used.</li>
<li><strong>Heap allocations</strong> made during the function (once the GC realizes they‚Äôre unreachable).</li>
</ul>
<p>This isn‚Äôt your typical ‚Äúset it to zero and hope for the best‚Äù approach. The runtime is actually going through and scrubbing these values before handing control back to your program.</p>
<h2 id="digging-a-little-deeper">Digging a little deeper</h2>
<p>Now, here‚Äôs where it gets interesting. The Go team didn‚Äôt just sprinkle some <code>memset</code> calls around and call it a day. They went deep into the runtime itself.</p>
<p>When you call <code>secret.Do(f)</code>, here‚Äôs what happens:</p>
<ol>
<li><strong>Mark the goroutine as ‚Äúin secret mode‚Äù</strong> - The runtime increments a counter on your goroutine to track that you‚Äôre handling secrets.</li>
<li><strong>Call your function</strong> - Pretty straightforward, except it‚Äôs wrapped in a panic handler.</li>
<li><strong>Erase the stack</strong> - Clear all the stack memory that was used by your function.</li>
<li><strong>Erase the registers</strong> - Zero out all CPU registers that might have held your data.</li>
<li><strong>Mark heap allocations</strong> - Tag any objects allocated during the function so the GC knows to zero them immediately when freeing.</li>
</ol>
<p>The assembly code for this is kind of beautiful in a ‚Äúwow, that‚Äôs thorough‚Äù way. On x86-64, they‚Äôre explicitly clearing XMM registers, general-purpose registers, the works. They‚Äôre even handling edge cases like what happens if your secret function gets preempted or receives a signal.</p>
<blockquote>
<p>And yes, before you ask: if your function panics, they <em>still</em> erase everything before re-raising the panic. They even modify the stack trace so it looks like the panic came from <code>secret.Do</code> itself, removing any trace of what happened inside your secret function. Now <em>that‚Äôs</em> commitment to the bit.</p>
</blockquote>
<h2 id="the-limitations">The limitations</h2>
<blockquote>
<p>Or: Why this isn‚Äôt a magic wand.</p>
</blockquote>
<p>Of course, nothing in life is free, and certainly nothing in systems programming is free. The <code>runtime/secret</code> package comes with some important limitations that you need to know about. Currently only works on <code>linux/amd64</code> and <code>linux/arm64</code> (I wonder why‚Ä¶). If you‚Äôre on macOS or Windows, or you‚Äôre running on some other architecture, <code>secret.Do</code> just calls your function directly and does nothing special. <em>This is an experiment, after all</em>.</p>
<p>You cannot launch a new goroutine from inside <code>secret.Do</code>. If you try, you‚Äôll get a panic. This makes sense when you think about it. How would the runtime track which memory belongs to your secret operation if it‚Äôs spread across multiple goroutines? The complexity would be nightmarish. Also, if you write secrets to global variables, you‚Äôre on your own. The package can‚Äôt help you there because, well, they‚Äôre global. They stick around.</p>
<p>Heap allocations are only erased after the garbage collector runs and determines they‚Äôre unreachable. If your program is hanging onto references (even accidentally), those secrets will stick around. The runtime can‚Äôt read your mind about when you‚Äôre <em>really</em> done with something. As the documentation rather ominously notes, ‚ÄúPointer addresses may leak into data buffers used by the runtime to perform garbage collection.‚Äù So if you‚Äôre encoding secrets into pointer values themselves (which you probably shouldn‚Äôt be doing anyway), those might leak.</p>
<p>Reading through these limitations, you might be thinking: ‚ÄúMan, that‚Äôs a lot of caveats.‚Äù And you‚Äôd be right! This is genuinely hard stuff. The fact that it works at all, and works reliably for the cases it supports, is pretty impressive. Perfect is the enemy of good, and this is <em>good enough</em> for a lot of real-world use cases.</p>
<h2 id="do-i-need-it">Do I need it?</h2>
<p>At first glance, you might think: ‚ÄúHow often does someone really get access to my process memory?‚Äù And if you‚Äôre building a CRUD app that talks to a database, maybe the answer is ‚Äúnot very often.‚Äù But in the real world, memory disclosure vulnerabilities show up with alarming regularity. Heartbleed, anyone? Or any of the dozens of buffer overflow bugs that get found every year?</p>
<p>For cryptographic code especially, this matters. If you‚Äôre implementing TLS, you want forward secrecy: even if an attacker later compromises your server and dumps all its memory, they shouldn‚Äôt be able to decrypt old sessions. But if your ephemeral keys are just sitting there in memory indefinitely, you don‚Äôt really have forward secrecy, do you? You‚Äôve got ‚Äúforward secrecy with an asterisk‚Äù.</p>
<p>The <code>runtime/secret</code> package gives you a way to actually achieve the security properties you‚Äôre claiming to have. It turns ‚Äúwe stop using the key‚Äù into ‚Äúwe actively destroy the key.‚Äù <strong>That‚Äôs a meaningful difference</strong>.</p>
<h2 id="the-implementation-is-the-interesting-part">The implementation is the interesting part</h2>
<p>What I find fascinating about this feature is how deep it goes into the runtime. The Go team didn‚Äôt just add a new library function; they modified the garbage collector, the stack growth logic, signal handling, preemption, even the vDSO (virtual dynamic shared object) interactions.</p>
<p>When your secret function grows its stack, the runtime now clears the old stack before deallocating it. When objects are allocated in secret mode, they get a special mark, and when they‚Äôre freed, they get immediately zeroed instead of just being added to the free list. The panic handler was modified to erase the stack trace of secret functions.</p>
<p>This is the kind of feature that requires understanding the runtime at a really deep level. It‚Äôs one thing to say ‚Äúwe should erase secrets from memory.‚Äù It‚Äôs another thing entirely to figure out all the places in the runtime where those secrets might leak and plug every single one of them.</p>
<blockquote>
<p>Looking at the commit, this work was initially started by Keith Randall back in 2023 (CL 600635), then picked up and enhanced by Daniel Morsing, who added ARM64 support, signal handling, and dealt with various edge cases. The fact that it took two years and multiple experienced runtime engineers to get this right should tell you something about the complexity involved.</p>
</blockquote>
<h2 id="code-time">Code time!</h2>
<p>So when should you actually use this? The obvious use case is cryptographic operations: key derivation, encryption, decryption, signing. Anywhere you‚Äôre handling data that really shouldn‚Äôt linger in memory.</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decryptPayload</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">encrypted</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic"> keyMaterial</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> ([]</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> plaintext </span><span style="color:#9399B2;--shiki-dark:#7C7F93">[]</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#CBA6F7;--shiki-dark:#8839EF">error</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    secret</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Do</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        key </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> deriveKey</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">keyMaterial</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decrypt</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">encrypted</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> key</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // key gets erased when this returns</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    return</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p>You could also use it for handling passwords, API tokens, or other credentials. Basically anywhere you‚Äôre thinking ‚ÄúI wish this data would just go away when I‚Äôm done with it‚Äù.</p>
<p>But <strong>don‚Äôt go overboard</strong>. You don‚Äôt need to wrap every function in <code>secret.Do</code>. The overhead isn‚Äôt huge, but it‚Äôs not zero either, the runtime is doing real work to scrub all that memory. Use it where it matters.</p>
<h2 id="7-years-in-the-making">7 years in the making</h2>
<p>This feature was requested in issue <code>#21865</code>, which was opened in September 2017. <strong>Seven</strong> years ago. That‚Äôs how long it took to go from ‚Äúhey, it would be nice if Go could erase secrets from memory‚Äù to ‚Äúhere‚Äôs a working implementation that handles all the edge cases.‚Äù</p>
<p>Some people might look at that timeline and think the Go team is slow. But I think it shows appropriate caution. Getting this wrong would be worse than not having it at all, because people would rely on it and have a false sense of security. Better to take the time to do it right.</p>
<p>And ‚Äúright‚Äù in this case means thinking through all the interactions with the rest of the runtime, handling panics and stack growth and preemption and signals, testing it thoroughly, and documenting the limitations clearly. The fact that this is still marked as an experiment (requiring <code>GOEXPERIMENT=runtimesecret</code> to enable) shows they‚Äôre being thoughtful about rolling it out.</p>
<h2 id="thats-it">That‚Äôs it.</h2>
<p>The <code>runtime/secret</code> package won‚Äôt solve all your security problems. It won‚Äôt protect you from SQL injection or XSS or a whole host of other vulnerabilities. What it <em>will</em> do is give you a practical way to ensure that sensitive data doesn‚Äôt linger in memory longer than necessary.</p>
<p>It‚Äôs the kind of feature that makes me appreciate the Go runtime team‚Äôs attention to detail. They could have shipped something half-baked that only handled the easy cases. Instead, they built something that actually works, documented its limitations honestly, and made it integrate cleanly with the rest of the language.</p>
<p>For folks building cryptographic systems, this is going to be a really useful tool. For everyone else, it‚Äôs a good reminder that <strong>security is hard</strong>, and that sometimes the best solution is to go deep into the runtime and fix things at the foundation level.</p>
<blockquote>
<p>And hey, if nothing else, it‚Äôs fun to read assembly code that‚Äôs explicitly designed to make sure your secrets can‚Äôt be recovered from memory. There‚Äôs something oddly satisfying about seeing all those XOR instructions that are just there to zero out registers.</p>
</blockquote>
<p>Now if you‚Äôll excuse me, I need to go wrap my password handling code in <code>secret.Do</code>. Better seven years late than never, right?</p>
<hr>
<p><em>To use it, build Go with <code>GOEXPERIMENT=runtimesecret</code>. Currently supported on linux/amd64 and linux/arm64.</em></p>
<h5 id="references">References</h5>
<ul>
<li><strong>Issue</strong>: <a href="https://github.com/golang/go/issues/21865">#21865 - proposal: Go 2: allow cryptographic packages to wipe stack memory</a></li>
<li><strong>Implementation</strong>: <a href="https://github.com/golang/go/commit/a3fb92a710">Commit a3fb92a710</a></li>
<li><strong>Code Review</strong>: <a href="https://go-review.googlesource.com/c/go/+/704615">CL 704615</a> (final implementation)</li>
<li><strong>Original CL</strong>: <a href="https://go-review.googlesource.com/c/go/+/600635">CL 600635</a> (initial work by Keith Randall)</li>
<li><strong>Package Documentation</strong>: <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret.go">src/runtime/secret/secret.go</a></li>
<li><strong>Test Examples</strong>: <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret_test.go">src/runtime/secret/secret_test.go</a></li>
</ul>  </main> <button id="back-to-top-btn" aria-label="back to top" class="z-50" data-astro-cid-xuhzuiaq> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" data-astro-cid-xuhzuiaq="true" class="w-7 h-7 sm:w-5 s:h-6" astro-icon="carbon:arrow-up"><path fill="currentColor" d="M16 4 6 14l1.41 1.41L15 7.83V28h2V7.83l7.59 7.58L26 14 16 4z"/></svg> </button>  <script type="module">const e=document.getElementById("back-to-top-btn");e&&(e.addEventListener("click",()=>{document.body.scrollTop=0,document.documentElement.scrollTop=0}),window.addEventListener("scroll",()=>{window.scrollY<document.documentElement.clientHeight?(e.classList.remove("fade-in"),e.classList.add("fade-out"),e.style.display="flex"):(e.classList.remove("fade-out"),e.classList.add("fade-in"))}));</script> </article>   <aside class="hidden sm:block"> <div class="flex flex-col space-y-2"> <h2 class="font-semibold text-lg text-textColor">Alex Rios</h2> <p>alexrios.me</p> <div class="flex flex-wrap items-end gap-x-4"> <ul class="flex flex-wrap flex-1 items-center gap-x-2 sm:flex-initial"> <li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://github.com/alexrios" target="_blank" rel="noopener noreferrer" title="Github"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:github"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> <span class="sr-only">Github</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://linkedin.com/in/the-alex-rios" target="_blank" rel="noopener noreferrer" title="LinkedIn"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:linkedin"><path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg> <span class="sr-only">LinkedIn</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://x.com/alextrending" target="_blank" rel="noopener noreferrer" title="twitter"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:twitter"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg> <span class="sr-only">twitter</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="/rss.xml" target="_blank" rel="noopener noreferrer" title="rss"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:rss"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg> <span class="sr-only">rss</span> </a> </li> </ul> </div> <span class="!my-4 text-accent" aria-hidden>---</span>
                    <p> the runtime/secret Package </p> <div class="pt-2 hidden md:block"> <span>Part of series: </span> <br> <ul> <li><a class="cody-link" href="/series/Go 1.26">Go 1.26</a></li> </ul> </div> <span class="!my-4 text-accent" aria-hidden>---</span>
                    <p> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="inline-block w-4 h-4 align-text-bottom" astro-icon="mdi:translate"><path fill="currentColor" d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>:
<a class="cody-link" href="/blog/secret-package-br"> üáßüá∑ </a> </p> </div> <nav class="sticky top-20 order-2 hidden basis-64 lg:block"> <hr> <h2 class="font-bold text-lg">Table of Contents</h2> <ul class="-me-32" id="toc"> <li data-astro-cid-zekvapgs> <a href="#the-problem-memory-is-a-tattoo-not-a-whiteboard" id="toc-the-problem-memory-is-a-tattoo-not-a-whiteboard" data-astro-cid-zekvapgs> The problem: memory is a tattoo, not a whiteboard </a>  </li> <li data-astro-cid-zekvapgs> <a href="#the-answer-secretdo" id="toc-the-answer-secretdo" data-astro-cid-zekvapgs> The answer secret.Do </a>  </li> <li data-astro-cid-zekvapgs> <a href="#digging-a-little-deeper" id="toc-digging-a-little-deeper" data-astro-cid-zekvapgs> Digging a little deeper </a>  </li> <li data-astro-cid-zekvapgs> <a href="#the-limitations" id="toc-the-limitations" data-astro-cid-zekvapgs> The limitations </a>  </li> <li data-astro-cid-zekvapgs> <a href="#do-i-need-it" id="toc-do-i-need-it" data-astro-cid-zekvapgs> Do I need it? </a>  </li> <li data-astro-cid-zekvapgs> <a href="#the-implementation-is-the-interesting-part" id="toc-the-implementation-is-the-interesting-part" data-astro-cid-zekvapgs> The implementation is the interesting part </a>  </li> <li data-astro-cid-zekvapgs> <a href="#code-time" id="toc-code-time" data-astro-cid-zekvapgs> Code time! </a>  </li> <li data-astro-cid-zekvapgs> <a href="#7-years-in-the-making" id="toc-7-years-in-the-making" data-astro-cid-zekvapgs> 7 years in the making </a>  </li> <li data-astro-cid-zekvapgs> <a href="#thats-it" id="toc-thats-it" data-astro-cid-zekvapgs> That‚Äôs it. </a> <ul class="ml-2" data-astro-cid-zekvapgs> <li data-astro-cid-zekvapgs> <a href="#references" id="toc-references" data-astro-cid-zekvapgs> References </a>  </li>  </ul> </li>  </ul> </nav> <script type="module">const c=document.getElementById("toc");c&&c?.addEventListener("click",t=>{const n=window.location.hash.slice(1),e=document.getElementById(`toc-${n}`);e instanceof HTMLElement&&e?.classList.remove("active-toc"),t.target instanceof HTMLElement&&t.target.classList.add("active-toc")});</script> </aside> </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold sm:flex-row sm:justify-between sm:text-xs text-textColor mb-8"> <div class="mr-2 sm:mr-0">
Copyright &copy; 2025  Alex Rios </div> <nav aria-label="More on this site" class="gap-x-0 sm:gap-x-2 sm:flex sm:divide-x sm:divide-accent"> <a href="/" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Home </a><a href="/about" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> About </a><a href="/blog" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Blog </a><a href="/books" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Books </a><a href="/speaker" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Speaker </a><a href="/archive" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Archive </a> </nav> </footer> </body></html> <script type="module">const n='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19V1h9l6 6v12zm8-11h5l-5-5zM2 23V7h2v14h11v2z"/></svg>',i=Array.from(document.querySelectorAll("pre.astro-code"));for(const t of i){let o=t.parentElement;if(o){let c=document.createElement("div");o.replaceChild(c,t),c.classList.add("relative"),c.appendChild(t);const e=document.createElement("button");e.className="cody-copy-code",e.innerHTML=n,e.title="Copy code block",t.setAttribute("tabindex","0"),c.appendChild(e),e.addEventListener("click",async()=>{await r(t,e)})}}async function r(t,o){const e=t.querySelector("code")?.innerText??"";await navigator.clipboard.writeText(e),o.innerText="Code Copied",setTimeout(()=>{o.innerHTML=n},700)}</script>