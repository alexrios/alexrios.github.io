<!DOCTYPE html><html lang="en" class="dark"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/icon.png"><meta name="generator" content="Astro v5.5.2"><!-- Font preloads --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://alexrios.me/blog/secret-package-br/"><!-- Primary Meta Tags --><title>Apagando segredos em Go | alexrios</title><meta name="title" content="Apagando segredos em Go"><meta name="description" content="o Package runtime/secret"><meta name="author" content="Alex Rios"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://alexrios.me/blog/secret-package-br/"><meta property="og:title" content="Apagando segredos em Go"><meta property="og:description" content="o Package runtime/secret"><meta property="og:image" content="https://alexrios.me/og-image/secret-package-br.png"><meta property="article:author" content="Alex Rios"><meta property="article:published_time" content="2025-12-14T03:00:00.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://alexrios.me/blog/secret-package-br/"><meta property="twitter:title" content="Apagando segredos em Go"><meta property="twitter:description" content="o Package runtime/secret"><meta property="twitter:image" content="https://alexrios.me/og-image/secret-package-br.png"><link rel="stylesheet" href="/_astro/about.BXhEje_b.css">
<link rel="stylesheet" href="/_astro/about.CeiC_4Zc.css">
<style>li[data-astro-cid-zekvapgs]:before{content:"#";margin-right:-.5rem;color:var(--theme-accent)}.active-toc[data-astro-cid-zekvapgs]{color:var(--theme-accent)}button[data-astro-cid-xuhzuiaq]{position:fixed;bottom:1rem;left:82%;display:none;height:3rem;width:3rem;align-items:center;justify-content:center;border-radius:9999px;background-color:var(--theme-accent);color:var(--theme-bg);--tw-shadow: 0 1px 3px 0 rgb(0 0 0 / .1), 0 1px 2px -1px rgb(0 0 0 / .1);--tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}button[data-astro-cid-xuhzuiaq]:hover{--tw-scale-x: 1.25;--tw-scale-y: 1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-shadow: 0 20px 25px -5px rgb(0 0 0 / .1), 0 8px 10px -6px rgb(0 0 0 / .1);--tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}@media (min-width: 640px){button[data-astro-cid-xuhzuiaq]{bottom:2rem;height:2.5rem;width:2.5rem}}@media (min-width: 768px){button[data-astro-cid-xuhzuiaq]{left:90%}}@media (min-width: 1536px){button[data-astro-cid-xuhzuiaq]{left:75%}}
</style></head> <body> <header class="group relative mb-8 flex justify-between items-center gap-4" id="main-header" data-astro-cid-3ef6ksr2> <div class="block" data-astro-cid-3ef6ksr2> <a class="title whitespace-nowrap" href="/" aria-current="false" data-astro-cid-3ef6ksr2>alexrios</a> </div> <nav class="mt-4 bg-surface/95 sm:bg-bgColor absolute hidden top-8 w-full sm:block sm:static sm:mt-0 group-[.menu-open]:z-50 group-[.menu-open]:flex group-[.menu-open]:bg-bgColor" id="navigation-menu" aria-label="main menu" data-astro-cid-3ef6ksr2> <div class="space-y-1 px-2 pb-3 pt-2 sm:flex sm:px-0 sm:py-0 sm:space-y-0 sm:space-x-2" data-astro-cid-3ef6ksr2> <a href="/" class="block py-2 sm:py-0" title="Home" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a> <a href="/about" class="block py-2 sm:py-0" title="About" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> About </a> <a href="/blog" class="block py-2 sm:py-0" title="Blog" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a> <a href="/books" class="block py-2 sm:py-0" title="Books" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Books </a> <a href="/speaker" class="block py-2 sm:py-0" title="Speaker" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Speaker </a> <a href="/archive" class="block py-2 sm:py-0" title="Archive" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Archive </a>  <a href="/tags" class="sm:hidden block py-2 sm:py-0" title="tags" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Tags </a>  <a href="/series" class="sm:hidden block py-2 sm:py-0" title="series" aria-current="false" data-astro-prefetch="true" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  </div> </nav> <div class="flex gap-2 items-center justify-center" data-astro-cid-3ef6ksr2> <button id="themeToggle" class="transition-all relative" aria-label="toggle theme" data-astro-cid-x3pjskd3> <svg width="25px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-astro-cid-x3pjskd3> <path class="sun opacity-100 transition-all dark:scale-0 dark:opacity-0" fill-rule="evenodd" d="M12 17.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zm0 1.5a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm12-7a.8.8 0 0 1-.8.8h-2.4a.8.8 0 0 1 0-1.6h2.4a.8.8 0 0 1 .8.8zM4 12a.8.8 0 0 1-.8.8H.8a.8.8 0 0 1 0-1.6h2.5a.8.8 0 0 1 .8.8zm16.5-8.5a.8.8 0 0 1 0 1l-1.8 1.8a.8.8 0 0 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM6.3 17.7a.8.8 0 0 1 0 1l-1.7 1.8a.8.8 0 1 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM12 0a.8.8 0 0 1 .8.8v2.5a.8.8 0 0 1-1.6 0V.8A.8.8 0 0 1 12 0zm0 20a.8.8 0 0 1 .8.8v2.4a.8.8 0 0 1-1.6 0v-2.4a.8.8 0 0 1 .8-.8zM3.5 3.5a.8.8 0 0 1 1 0l1.8 1.8a.8.8 0 1 1-1 1L3.5 4.6a.8.8 0 0 1 0-1zm14.2 14.2a.8.8 0 0 1 1 0l1.8 1.7a.8.8 0 0 1-1 1l-1.8-1.7a.8.8 0 0 1 0-1z" data-astro-cid-x3pjskd3></path> <path class="moon opacity-0 transition-all dark:scale-100 dark:opacity-100" fill-rule="evenodd" d="M16.5 6A10.5 10.5 0 0 1 4.7 16.4 8.5 8.5 0 1 0 16.4 4.7l.1 1.3zm-1.7-2a9 9 0 0 1 .2 2 9 9 0 0 1-11 8.8 9.4 9.4 0 0 1-.8-.3c-.4 0-.8.3-.7.7a10 10 0 0 0 .3.8 10 10 0 0 0 9.2 6 10 10 0 0 0 4-19.2 9.7 9.7 0 0 0-.9-.3c-.3-.1-.7.3-.6.7a9 9 0 0 1 .3.8z" data-astro-cid-x3pjskd3></path> </svg> </button>  <script>
  const theme = (() => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme');
    }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
      return 'light';
  })();

  if (theme === 'light') {
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }

  window.localStorage.setItem('theme', theme);

  const handleToggleClick = () => {
    const element = document.documentElement;
    element.classList.toggle("dark");

    const isDark = element.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }

  document.getElementById("themeToggle").addEventListener("click", handleToggleClick);
</script> <nav-button data-astro-cid-3ef6ksr2="true"> <div class="sm:hidden" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>open main menu</span> <button class="group flex items-center justify-center" type="button" id="navigation-menu-btn" aria-label="Open main menu" aria-expanded="false" aria-haspopup="menu" data-astro-cid-3ef6ksr2> <!-- icon when menu is closed --> <svg class="transform transition-all duration-150 ease-out group-aria-expanded:scale-0 group-aria-expanded:opacity-0 h-6 w-6 block group-aria-expanded:hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" data-astro-cid-3ef6ksr2></path> </svg> <!-- icon when menu is open --> <svg class="transform transition-all duration-150 ease-out h-6 w-6 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100 hidden group-aria-expanded:block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-astro-cid-3ef6ksr2> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-astro-cid-3ef6ksr2></path> </svg> </button> </div> </nav-button> </div> </header>  <script type="module">class e extends HTMLElement{headerEl;mobileButtonEl;menuOpen;constructor(){super(),this.headerEl=document.getElementById("main-header"),this.mobileButtonEl=this.querySelector("button"),this.menuOpen=!1,this.mobileButtonEl.addEventListener("click",this.toggleMobileMenu)}toggleMobileMenu=()=>{this.headerEl.classList.toggle("menu-open"),this.menuOpen=!this.menuOpen,this.mobileButtonEl.setAttribute("aria-expanded",this.menuOpen.toString())}}customElements.define("nav-button",e);</script> <main class="grid grid-cols-1 gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-4">  <article class="cody-bg prose dark:prose-invert prose-cody text-textColor max-w-4xl"> <header class="space-y-2"> <div class="aspect-h-9 aspect-w-16 mb-6 w-full flex justify-center"> <img src="/cpu.png" alt="secret" class="m-0"> </div> <div class="md:sr-only not-sr-only"> <span>Part of series:</span> <a class="cody-link" href="/series/Go 1.26">Go 1.26</a> </div> <div class="flex gap-2 items-center"> <h1 class="text-3xl my-0">Apagando segredos em Go</h1>  </div> <span class="font-semibold text-textColor flex gap-2 items-center"> <time datetime="2025-12-14T03:00:00.000Z" title="14 December 2025"> 14 December 2025 </time> <span>
/ 10 min read </span>  </span> <ul class="not-prose flex gap-2 flex-wrap"> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" class="w-5 h-5" astro-icon="carbon:tag-group"><circle cx="10" cy="14" r="2" fill="currentColor"/><path fill="currentColor" d="M16 30a1 1 0 0 1-.71-.29L4.59 19A2 2 0 0 1 4 17.59V10a2 2 0 0 1 2-2h7.59a2 2 0 0 1 1.41.59l10.71 10.7a1 1 0 0 1 0 1.42l-9 9A1 1 0 0 1 16 30zM6 10v7.59l10 10L23.59 20l-10-10z"/><path fill="currentColor" d="M27.71 13.29 17 2.59A2 2 0 0 0 15.59 2H8a2 2 0 0 0-2 2v2h2V4h7.59l10 10-1.3 1.29 1.42 1.42 2-2a1 1 0 0 0 0-1.42z"/></svg> <li class="tag"> <a href="/tags/go">go</a> </li><li class="tag"> <a href="/tags/package">package</a> </li><li class="tag"> <a href="/tags/secret">secret</a> </li> </ul> </header> <hr class="my-4"> <main class="prose-headings:font-semibold prose-headings:ml-4 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none prose-a:text-accent">  <p>Quando você trabalha com chaves criptográficas, senhas ou outros dados sensíveis nos seus programas, existe um problema que tem ficado na sombra há décadas: mesmo depois que você termina de usar esses dados, eles ainda estão lá na memória. Stack frames, registradores, alocações no heap. Tudo vira uma espécie de registro arqueológico dos seus segredos, esperando alguém com um dump de memória ou um debugger aparecer e desenterrá-los.</p>
<p>O Go vai introduzir um package experimental <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret.go"><code>runtime/secret</code></a> que tenta resolver esse problema (de um jeito que é realmente prático). É o tipo de feature que faz você pensar “por que demorou tanto?”, até você começar a pensar nos detalhes de implementação e perceber, “ah, <em>foi por isso</em>.”</p>
<h2 id="o-problema-memória-é-uma-tatuagem-não-um-quadro-branco">O problema: memória é uma tatuagem, não um quadro branco</h2>
<p>Vamos começar pelo que estamos tentando resolver. Quando você escreve código que manipula dados sensíveis, digamos que você está implementando TLS ou processando números de cartão de crédito, os dados fluem pelo seu programa: eles vivem nos registradores quando a CPU está trabalhando ativamente com eles, na stack como variáveis locais, e no heap quando você aloca memória. Quando você termina de usar, você pode até colocar essas variáveis como zero ou nil e considerar o trabalho feito.</p>
<p>Mas o lance é que isso não apaga os dados de verdade. Quando você reatribui uma variável, você está só dizendo para o programa parar de se preocupar com aquela posição de memória. Os bytes em si? Eles continuam lá, de boa, esperando algo sobrescrever eles. E se alguém conseguir acesso à memória do seu processo, através de um core dump, uma vulnerabilidade de memória, ou simplesmente acesso root, eles podem ir “pescando” esses valores antigos.</p>
<p>Isso importa muito pra <em>forward secrecy</em>. Se você está fazendo key exchange e alguém depois faz dump da memória do seu processo, você não quer que eles consigam reconstruir chaves de sessões antigas. Você quer essas chaves <em>sumidas</em>. Não “tecnicamente desalocadas”, mas “sobrescritas com zeros e impossível de recuperar”, <em>sumidas mesmo</em>.</p>
<p>O pessoal da segurança se preocupa com isso há anos, e com razão. Você pode escrever o código crypto mais à prova de balas do mundo, mas se seus segredos estão lá na memória tipo jornal velho no sótão, você tem um problema.</p>
<h2 id="a-solução-secretdo">A solução: <code>secret.Do</code></h2>
<p>O novo package <code>runtime/secret</code> te dá uma função chamada <code>Do</code> que envolve suas operações sensíveis. A ideia básica é:</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">import</span><span style="color:#A6E3A1;--shiki-dark:#40A02B"> "runtime/secret"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">secret</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Do</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Manipule seus dados sensíveis aqui</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    key </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> deriveEncryptionKey</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#94E2D5;--shiki-dark:#179299">...</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    plaintext </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decrypt</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">ciphertext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> key</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">    process</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">    // Quando essa função retornar, o Go vai apagar tudo</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">})</span></span></code></pre>
<p>Quando <code>secret.Do</code> retorna, o runtime do Go ativamente apaga:</p>
<ul>
<li><strong>Todos os registradores</strong> que foram usados pela sua função.</li>
<li><strong>A stack inteira</strong> que sua função usou.</li>
<li><strong>Alocações no heap</strong> feitas durante a função (quando o GC perceber que não são mais alcançáveis).</li>
</ul>
<p>Isso não é aquela abordagem típica de “seta pra zero e torce pro melhor”. O runtime está literalmente passando e limpando esses valores antes de devolver o controle pro seu programa.</p>
<h2 id="cavando-mais-fundo">Cavando mais fundo</h2>
<p>Agora é que a coisa fica interessante. O time do Go não simplesmente espalhou uns <code>memset</code> por aí e considerou o trabalho feito. Eles foram fundo no runtime mesmo.</p>
<p>Quando você chama <code>secret.Do(f)</code>, aqui está o que acontece:</p>
<ol>
<li><strong>Marca a goroutine como “modo secreto”</strong> - O runtime incrementa um contador na sua goroutine pra rastrear que você está manipulando segredos.</li>
<li><strong>Chama sua função</strong> - Bem direto, exceto que está envolvida num handler de panic.</li>
<li><strong>Apaga a stack</strong> - Limpa toda a memória da stack que foi usada pela sua função.</li>
<li><strong>Apaga os registradores</strong> - Zera todos os registradores da CPU que podem ter guardado seus dados.</li>
<li><strong>Marca alocações no heap</strong> - Tageia quaisquer objetos alocados durante a função pra que o GC saiba zerar eles imediatamente quando liberar.</li>
</ol>
<p>O código assembly pra isso é meio que bonito num jeito “caramba, que completo”. No x86-64, eles estão explicitamente limpando registradores XMM, registradores de propósito geral, tudo. Eles até estão lidando com edge cases tipo o que acontece se sua função secreta for preemptada ou receber um signal.</p>
<blockquote>
<p>E sim, antes de você perguntar: se sua função entra em panic, eles <em>ainda assim</em> apagam tudo antes de re-lançar o panic. Eles até modificam o stack trace pra parecer que o panic veio do próprio <code>secret.Do</code>, removendo qualquer traço do que aconteceu dentro da sua função secreta. Agora <em>isso</em> é compromisso com a causa.</p>
</blockquote>
<h2 id="as-limitações">As limitações</h2>
<blockquote>
<p>Ou: Por que isso não é uma varinha mágica.</p>
</blockquote>
<p>Claro, nada na vida é de graça, e certamente nada em programação de sistemas é de graça. O package <code>runtime/secret</code> vem com algumas limitações importantes que você precisa saber. Atualmente só funciona em <code>linux/amd64</code> e <code>linux/arm64</code> (me pergunto por quê…). Se você está no macOS ou Windows, ou rodando em alguma outra arquitetura, <code>secret.Do</code> simplesmente chama sua função diretamente e não faz nada de especial. <em>Afinal, É um experimento</em>.</p>
<p>Você não pode lançar uma nova goroutine de dentro do <code>secret.Do</code>. Se tentar, vai ter um panic. Isso faz sentido quando você pensa sobre isso. Como o runtime rastrearia qual memória pertence à sua operação secreta se ela está espalhada por múltiplas goroutines? A complexidade seria um pesadelo. Além disso, se você escrever segredos em variáveis globais, você está por sua conta. O package não pode te ajudar porque, bem, elas são globais. Elas ficam por aí.</p>
<p>Alocações no heap só são apagadas depois que o garbage collector roda e determina que não são mais alcançáveis. Se seu programa está segurando referências (até mesmo acidentalmente), esses segredos vão ficar por aí. O runtime não consegue ler sua mente sobre quando você está <em>realmente</em> terminado com algo. Como a documentação meio que nota ominosamente, “Endereços de ponteiros podem vazar em buffers de dados usados pelo runtime pra fazer garbage collection.” Então se você está codificando segredos nos próprios valores de ponteiro (o que você provavelmente não deveria estar fazendo de qualquer maneira), eles podem vazar.</p>
<p>Lendo essas limitações, você pode estar pensando: “Cara, são muitas ressalvas.” E você estaria certo! Isso é coisa genuinamente difícil. O fato de funcionar de qualquer jeito, e funcionar de forma confiável pros casos que suporta, é bem impressionante. O perfeito é inimigo do bom, e isso é <em>bom o suficiente</em> pra muitos casos de uso do mundo real.</p>
<h2 id="eu-preciso-disso">Eu preciso disso?</h2>
<p>À primeira vista, você pode pensar: “Com que frequência alguém realmente consegue acesso à memória do meu processo?” E se você está construindo um CRUD que fala com banco de dados, talvez a resposta seja “não muito frequentemente.” Mas no mundo real, vulnerabilidades de disclosure de memória aparecem com uma regularidade alarmante. Lembra do Heartbleed? Ou qualquer um das dúzias de bugs de buffer overflow que são encontrados todo ano?</p>
<p>Especialmente pra código criptográfico, isso importa. Se você está implementando TLS, você quer forward secrecy: mesmo se um atacante depois comprometer seu servidor e fazer dump de toda sua memória, eles não deveriam conseguir descriptografar sessões antigas. Mas se suas chaves efêmeras estão simplesmente lá na memória indefinidamente, você não tem forward secrecy de verdade, tem? Você tem “forward secrecy com asterisco”.</p>
<p>O package <code>runtime/secret</code> te dá uma forma de realmente alcançar as propriedades de segurança que você está alegando ter. Ele transforma “a gente para de usar a chave” em “a gente ativamente destrói a chave.” <strong>Essa é uma diferença significativa</strong>.</p>
<h2 id="a-implementação-é-a-parte-interessante">A implementação é a parte interessante</h2>
<p>O que eu acho fascinante sobre essa feature é o quão fundo ela vai no runtime. O time do Go não simplesmente adicionou uma nova função de biblioteca; eles modificaram o garbage collector, a lógica de crescimento de stack, signal handling, preempção, até as interações com vDSO (virtual dynamic shared object).</p>
<p>Quando sua função secreta cresce sua stack, o runtime agora limpa a stack antiga antes de desalocar ela. Quando objetos são alocados em modo secreto, eles recebem uma marca especial, e quando são liberados, são imediatamente zerados ao invés de simplesmente serem adicionados à free list. O panic handler foi modificado pra apagar o stack trace de funções secretas.</p>
<p>Esse é o tipo de feature que requer entender o runtime num nível realmente profundo. Uma coisa é dizer “a gente deveria apagar segredos da memória.” Outra coisa completamente diferente é descobrir todos os lugares no runtime onde esses segredos podem vazar e tapar cada um deles.</p>
<blockquote>
<p>Olhando o commit, esse trabalho foi inicialmente começado pelo Keith Randall lá em 2023 (CL 600635), depois foi continuado e aprimorado pelo Daniel Morsing, que adicionou suporte ARM64, signal handling, e lidou com vários edge cases. O fato de ter levado dois anos e múltiplos engenheiros experientes de runtime pra fazer isso direito deveria te dizer algo sobre a complexidade envolvida.</p>
</blockquote>
<h2 id="código">Código</h2>
<p>Então quando você deveria realmente usar isso? O caso de uso óbvio é operações criptográficas: derivação de chave, criptografia, descriptografia, assinatura. Em qualquer lugar que você esteja manipulando dados que realmente não deveriam ficar na memória.</p>
<pre class="astro-code astro-code-themes catppuccin-mocha catppuccin-latte" style="background-color:#1e1e2e;--shiki-dark-bg:#eff1f5;color:#cdd6f4;--shiki-dark:#4c4f69; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decryptPayload</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic">encrypted</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#EBA0AC;font-style:italic;--shiki-dark:#E64553;--shiki-dark-font-style:italic"> keyMaterial</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> []</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> ([]</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CBA6F7;--shiki-dark:#8839EF"> error</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> plaintext </span><span style="color:#9399B2;--shiki-dark:#7C7F93">[]</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">byte</span></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    var</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#CBA6F7;--shiki-dark:#8839EF">error</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">    secret</span><span style="color:#9399B2;--shiki-dark:#7C7F93">.</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic">Do</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CBA6F7;--shiki-dark:#8839EF">func</span><span style="color:#9399B2;--shiki-dark:#7C7F93">()</span><span style="color:#9399B2;--shiki-dark:#7C7F93"> {</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        key </span><span style="color:#94E2D5;--shiki-dark:#179299">:=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> deriveKey</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">keyMaterial</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#CDD6F4;--shiki-dark:#4C4F69">        plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err </span><span style="color:#94E2D5;--shiki-dark:#179299">=</span><span style="color:#89B4FA;font-style:italic;--shiki-dark:#1E66F5;--shiki-dark-font-style:italic"> decrypt</span><span style="color:#9399B2;--shiki-dark:#7C7F93">(</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69">encrypted</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> key</span><span style="color:#9399B2;--shiki-dark:#7C7F93">)</span></span>
<span class="line"><span style="color:#6C7086;font-style:italic;--shiki-dark:#9CA0B0;--shiki-dark-font-style:italic">        // key é apagada quando isso retornar</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7;--shiki-dark:#8839EF">    return</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> plaintext</span><span style="color:#9399B2;--shiki-dark:#7C7F93">,</span><span style="color:#CDD6F4;--shiki-dark:#4C4F69"> err</span></span>
<span class="line"><span style="color:#9399B2;--shiki-dark:#7C7F93">}</span></span></code></pre>
<p>Você também pode usar pra manipular senhas, tokens de API, ou outras credenciais. Basicamente em qualquer lugar que você esteja pensando “eu queria que esses dados simplesmente sumissem quando eu terminasse com eles”.</p>
<p>Mas <strong>não exagere</strong>. Você não precisa envolver toda função em <code>secret.Do</code>. O overhead não é enorme, mas também não é zero, o runtime está fazendo trabalho de verdade pra limpar toda aquela memória. Use onde importa.</p>
<h2 id="sete-anos-de-trabalho">Sete anos de trabalho</h2>
<p>Essa feature foi solicitada na issue <code>#21865</code>, que foi aberta em setembro de 2017. <strong>Sete</strong> anos atrás. Foi quanto tempo levou pra ir de “ei, seria legal se o Go pudesse apagar segredos da memória” pra “aqui está uma implementação funcionando que lida com todos os edge cases.”</p>
<p>Algumas pessoas podem olhar pra essa timeline e pensar que o time do Go é lento. Mas eu acho que mostra cautela apropriada. Fazer isso errado seria pior do que não ter, porque as pessoas iriam confiar nisso e ter uma falsa sensação de segurança. Melhor levar o tempo pra fazer direito.</p>
<p>E “direito” nesse caso significa pensar em todas as interações com o resto do runtime, lidar com panics e crescimento de stack e preempção e signals, testar minuciosamente, e documentar as limitações claramente. O fato de ainda estar marcado como experimento (requerendo <code>GOEXPERIMENT=runtimesecret</code> pra habilitar) mostra que eles estão sendo cuidadosos sobre o rollout.</p>
<h2 id="é-o-que-tem-para-hoje">”É o que tem para hoje”</h2>
<p>O package <code>runtime/secret</code> não vai resolver todos os seus problemas de segurança. Ele não vai te proteger de SQL injection ou XSS ou uma porção de outras vulnerabilidades. O que ele <em>vai</em> fazer é te dar uma forma prática de garantir que dados sensíveis não fiquem na memória mais tempo do que o necessário.</p>
<p>É o tipo de feature que me faz apreciar a atenção aos detalhes do time de runtime do Go. Eles poderiam ter lançado algo pela metade que só lidasse com os casos fáceis. Ao invés disso, eles construíram algo que realmente funciona, documentaram as limitações honestamente, e fizeram integrar de forma limpa com o resto da linguagem.</p>
<p>Pra quem está construindo sistemas criptográficos, isso vai ser uma ferramenta muito útil. Pra todo mundo mais, é um bom lembrete de que <strong>segurança é difícil</strong>, e que às vezes a melhor solução é ir fundo no runtime e consertar as coisas no nível da fundação.</p>
<blockquote>
<p>E ei, se nada mais, é divertido ler código assembly que é explicitamente projetado pra garantir que seus segredos não possam ser recuperados da memória. Tem algo estranhamente satisfatório em ver todas aquelas instruções XOR que estão ali só pra zerar registradores.</p>
</blockquote>
<p>Agora se me dá licença, eu preciso ir envolver meu código de manipulação de senha em <code>secret.Do</code>. Melhor sete anos atrasado do que nunca, né?</p>
<hr>
<p><em>Pra usar, compile o Go com <code>GOEXPERIMENT=runtimesecret</code>. Atualmente suportado em linux/amd64 e linux/arm64.</em></p>
<h5 id="referências">Referências</h5>
<ul>
<li><strong>Issue</strong>: <a href="https://github.com/golang/go/issues/21865">#21865 - proposal: Go 2: allow cryptographic packages to wipe stack memory</a></li>
<li><strong>Implementação</strong>: <a href="https://github.com/golang/go/commit/a3fb92a710">Commit a3fb92a710</a></li>
<li><strong>Code Review</strong>: <a href="https://go-review.googlesource.com/c/go/+/704615">CL 704615</a> (implementação final)</li>
<li><strong>CL Original</strong>: <a href="https://go-review.googlesource.com/c/go/+/600635">CL 600635</a> (trabalho inicial do Keith Randall)</li>
<li><strong>Documentação do Package</strong>: <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret.go">src/runtime/secret/secret.go</a></li>
<li><strong>Exemplos de Teste</strong>: <a href="https://github.com/golang/go/blob/a3fb92a710/src/runtime/secret/secret_test.go">src/runtime/secret/secret_test.go</a></li>
</ul>  </main> <button id="back-to-top-btn" aria-label="back to top" class="z-50" data-astro-cid-xuhzuiaq> <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false" data-astro-cid-xuhzuiaq="true" class="w-7 h-7 sm:w-5 s:h-6" astro-icon="carbon:arrow-up"><path fill="currentColor" d="M16 4 6 14l1.41 1.41L15 7.83V28h2V7.83l7.59 7.58L26 14 16 4z"/></svg> </button>  <script type="module">const e=document.getElementById("back-to-top-btn");e&&(e.addEventListener("click",()=>{document.body.scrollTop=0,document.documentElement.scrollTop=0}),window.addEventListener("scroll",()=>{window.scrollY<document.documentElement.clientHeight?(e.classList.remove("fade-in"),e.classList.add("fade-out"),e.style.display="flex"):(e.classList.remove("fade-out"),e.classList.add("fade-in"))}));</script> </article>   <aside class="hidden sm:block"> <div class="flex flex-col space-y-2"> <h2 class="font-semibold text-lg text-textColor">Alex Rios</h2> <p>alexrios.me</p> <div class="flex flex-wrap items-end gap-x-4"> <ul class="flex flex-wrap flex-1 items-center gap-x-2 sm:flex-initial"> <li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://github.com/alexrios" target="_blank" rel="noopener noreferrer" title="Github"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:github"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> <span class="sr-only">Github</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://linkedin.com/in/the-alex-rios" target="_blank" rel="noopener noreferrer" title="LinkedIn"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:linkedin"><path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg> <span class="sr-only">LinkedIn</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="https://x.com/alextrending" target="_blank" rel="noopener noreferrer" title="twitter"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:twitter"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg> <span class="sr-only">twitter</span> </a> </li><li class="flex"> <a class="inline-block p-1 sm:hover:text-accent hover:animate-spin" href="/rss.xml" target="_blank" rel="noopener noreferrer" title="rss"> <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="h-5 w-5" astro-icon="mdi:rss"><path fill="currentColor" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg> <span class="sr-only">rss</span> </a> </li> </ul> </div> <span class="!my-4 text-accent" aria-hidden>---</span>
                    <p> o Package runtime/secret </p> <div class="pt-2 hidden md:block"> <span>Part of series: </span> <br> <ul> <li><a class="cody-link" href="/series/Go 1.26">Go 1.26</a></li> </ul> </div>  </div> <nav class="sticky top-20 order-2 hidden basis-64 lg:block"> <hr> <h2 class="font-bold text-lg">Table of Contents</h2> <ul class="-me-32" id="toc"> <li data-astro-cid-zekvapgs> <a href="#o-problema-memória-é-uma-tatuagem-não-um-quadro-branco" id="toc-o-problema-memória-é-uma-tatuagem-não-um-quadro-branco" data-astro-cid-zekvapgs> O problema: memória é uma tatuagem, não um quadro branco </a>  </li> <li data-astro-cid-zekvapgs> <a href="#a-solução-secretdo" id="toc-a-solução-secretdo" data-astro-cid-zekvapgs> A solução: secret.Do </a>  </li> <li data-astro-cid-zekvapgs> <a href="#cavando-mais-fundo" id="toc-cavando-mais-fundo" data-astro-cid-zekvapgs> Cavando mais fundo </a>  </li> <li data-astro-cid-zekvapgs> <a href="#as-limitações" id="toc-as-limitações" data-astro-cid-zekvapgs> As limitações </a>  </li> <li data-astro-cid-zekvapgs> <a href="#eu-preciso-disso" id="toc-eu-preciso-disso" data-astro-cid-zekvapgs> Eu preciso disso? </a>  </li> <li data-astro-cid-zekvapgs> <a href="#a-implementação-é-a-parte-interessante" id="toc-a-implementação-é-a-parte-interessante" data-astro-cid-zekvapgs> A implementação é a parte interessante </a>  </li> <li data-astro-cid-zekvapgs> <a href="#código" id="toc-código" data-astro-cid-zekvapgs> Código </a>  </li> <li data-astro-cid-zekvapgs> <a href="#sete-anos-de-trabalho" id="toc-sete-anos-de-trabalho" data-astro-cid-zekvapgs> Sete anos de trabalho </a>  </li> <li data-astro-cid-zekvapgs> <a href="#é-o-que-tem-para-hoje" id="toc-é-o-que-tem-para-hoje" data-astro-cid-zekvapgs> ”É o que tem para hoje” </a> <ul class="ml-2" data-astro-cid-zekvapgs> <li data-astro-cid-zekvapgs> <a href="#referências" id="toc-referências" data-astro-cid-zekvapgs> Referências </a>  </li>  </ul> </li>  </ul> </nav> <script type="module">const c=document.getElementById("toc");c&&c?.addEventListener("click",t=>{const n=window.location.hash.slice(1),e=document.getElementById(`toc-${n}`);e instanceof HTMLElement&&e?.classList.remove("active-toc"),t.target instanceof HTMLElement&&t.target.classList.add("active-toc")});</script> </aside> </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold sm:flex-row sm:justify-between sm:text-xs text-textColor mb-8"> <div class="mr-2 sm:mr-0">
Copyright &copy; 2025  Alex Rios </div> <nav aria-label="More on this site" class="gap-x-0 sm:gap-x-2 sm:flex sm:divide-x sm:divide-accent"> <a href="/" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Home </a><a href="/about" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> About </a><a href="/blog" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Blog </a><a href="/books" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Books </a><a href="/speaker" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Speaker </a><a href="/archive" class="px-2 py-0 hover:text-textColor hover:underline sm:px-4 sm:py-2"> Archive </a> </nav> </footer> </body></html> <script type="module">const n='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19V1h9l6 6v12zm8-11h5l-5-5zM2 23V7h2v14h11v2z"/></svg>',i=Array.from(document.querySelectorAll("pre.astro-code"));for(const t of i){let o=t.parentElement;if(o){let c=document.createElement("div");o.replaceChild(c,t),c.classList.add("relative"),c.appendChild(t);const e=document.createElement("button");e.className="cody-copy-code",e.innerHTML=n,e.title="Copy code block",t.setAttribute("tabindex","0"),c.appendChild(e),e.addEventListener("click",async()=>{await r(t,e)})}}async function r(t,o){const e=t.querySelector("code")?.innerText??"";await navigator.clipboard.writeText(e),o.innerText="Code Copied",setTimeout(()=>{o.innerHTML=n},700)}</script>